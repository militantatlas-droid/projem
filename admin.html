<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>MİLİTAN ATLASI | ADMİN PANEL PRO</title>
  <style>
    :root { 
      --bg-body: #111; --bg-map: #1a1a1a; --accent: #3b82f6;
      --sidebar-bg: #181818; --text-main: #eee; --text-dim: #aaa;
      --aktif: #10b981; --pasif: #ef4444; --bilinmiyor: #6b7280;
    }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; overflow: hidden; height: 100vh; }
    #app { display: flex; flex-direction: column; height: 100vh; }
    
    /* HEADER & STATS */
    #header { height: 60px; background: #000; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000; }
    #stats-bar { background: #0a0a0a; padding: 8px 20px; display: flex; gap: 15px; font-size: 11px; border-bottom: 1px solid #222; color: var(--text-dim); }
    .stat-item b { color: #fff; background: #333; padding: 2px 6px; border-radius: 3px; margin-left: 4px; }

    #main { display: flex; flex: 1; position: relative; overflow: hidden; }

    /* SOL FİLTRE PANELİ */
    #filter-panel { width: 280px; background: #151515; border-right: 1px solid #222; display: flex; flex-direction: column; padding: 15px; overflow-y: auto; }
    .filter-btn { background: #222; border: 1px solid #333; color: #fff; padding: 10px; margin-bottom: 5px; border-radius: 5px; cursor: pointer; text-align: left; font-size: 12px; transition: 0.2s; }
    .filter-btn:hover { background: #333; }
    .filter-btn.active { border-color: var(--accent); background: #1e293b; }
    #filter-results { margin-top: 15px; }
    .result-item { padding: 10px; border-bottom: 1px solid #222; font-size: 13px; cursor: pointer; color: var(--text-dim); border-radius: 4px; }
    .result-item:hover { color: #fff; background: #222; }

    /* HARİTA ALANI */
    #map-container { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: var(--bg-map); overflow: hidden; }
    svg { width: 100%; height: 100%; transition: 0.3s; }
    /* Harita Beyaz Yapıldı */
    path { fill: #ffffff; stroke: #999; stroke-width: 0.3; transition: 0.2s; cursor: pointer; }
    path:hover { fill: #e2e8f0; stroke: var(--accent); }
    path.selected { fill: #cbd5e1 !important; stroke: var(--accent); stroke-width: 1.5; }

    /* SAĞ EDİTÖR PANELİ */
    #editor-panel {
      width: 500px; background: var(--sidebar-bg); border-left: 1px solid #333;
      position: absolute; right: 0; top: 0; bottom: 0; z-index: 2000;
      transform: translateX(100%); transition: transform 0.3s ease;
      display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.5);
    }
    #editor-panel.active { transform: translateX(0); }
    .panel-content { flex: 1; overflow-y: auto; padding: 25px; }

    .field-label { font-size: 10px; font-weight: bold; color: var(--text-dim); margin: 15px 0 5px; display: block; text-transform: uppercase; }
    .input-text { width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 5px; box-sizing: border-box; font-size: 14px; }
    .choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
    .choice-btn { background: #222; border: 1px solid #333; color: var(--text-dim); padding: 8px; border-radius: 5px; cursor: pointer; font-size: 11px; text-align: center; }
    .choice-btn.active { border-color: var(--accent); color: #fff; background: #1e293b; }

    .tabs { display: flex; overflow-x: auto; gap: 5px; margin: 20px 0 10px; padding-bottom: 5px; border-bottom: 1px solid #222; }
    .tab-btn { background: #222; color: var(--text-dim); border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; white-space: nowrap; }
    .tab-btn.active { background: var(--accent); color: #fff; }

    .rich-editor { min-height: 280px; background: #0a0a0a; border: 1px solid #333; border-radius: 5px; padding: 15px; outline: none; line-height: 1.6; font-size: 14px; overflow-y: auto; color: #ddd; }
    
    .pill { display: inline-block; padding: 6px 14px; background: #222; margin: 3px; border-radius: 4px; font-size: 12px; cursor: pointer; border: 1px solid #333; color: #fff; }
    .pill.active { background: var(--accent); border-color: var(--accent); }

    .btn-main { background: var(--accent); color: #fff; border: none; padding: 14px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 15px; font-size: 13px; }
    .btn-main:hover { background: #2563eb; }

    #tooltip { position: absolute; pointer-events: none; background: #000; color: #fff; padding: 5px 10px; border-radius: 4px; display: none; z-index: 3000; border: 1px solid #444; font-size: 11px; }
  </style>
</head>
<body onload="init()">

<div id="app">
  <div id="header">
    <div style="font-weight: bold; letter-spacing: 1px; font-size: 18px;">MİLİTAN ATLASI <span style="color:var(--accent)">EDITOR</span></div>
    <div>
      <input type="file" id="load-file" style="display:none" onchange="handleFile(this)">
      <button class="choice-btn" style="padding: 8px 15px;" onclick="document.getElementById('load-file').click()">JSON YÜKLE</button>
      <button class="choice-btn" style="padding: 8px 15px; margin-left: 10px; background: #333; color: #fff; border:none;" onclick="saveJSON()">JSON İNDİR (DOSYA)</button>
    </div>
  </div>

  <div id="stats-bar">
    <div class="stat-item">Toplam: <b id="st-total">0</b></div>
    <div class="stat-item">Cihatçı: <b id="st-cihat">0</b></div>
    <div class="stat-item">Ayrılıkçı: <b id="st-ayri">0</b></div>
    <div class="stat-item">Devrimci: <b id="st-devrim">0</b></div>
    <div class="stat-item">Diğer: <b id="st-diger">0</b></div>
    <div style="flex:1"></div>
    <div class="stat-item">Aktif: <b id="st-aktif" style="background:var(--aktif)">0</b></div>
    <div class="stat-item">Pasif: <b id="st-pasif" style="background:var(--pasif)">0</b></div>
  </div>

  <div id="main">
    <div id="filter-panel">
      <div class="field-label">Kategori Filtresi</div>
      <button class="filter-btn active" onclick="filterBy('Tümü', this)">Tüm Gruplar</button>
      <button class="filter-btn" onclick="filterBy('Cihatçı', this)">Cihatçı Örgütler</button>
      <button class="filter-btn" onclick="filterBy('Ayrılıkçı', this)">Ayrılıkçı Örgütler</button>
      <button class="filter-btn" onclick="filterBy('Devrimci', this)">Devrimci Örgütler</button>
      <button class="filter-btn" onclick="filterBy('Diğer', this)">Diğer</button>
      
      <div id="filter-results"></div>
    </div>

    <div id="map-container" onclick="closePanel()">
      <div id="tooltip"></div>
      <div id="map-wrapper">
        <svg id="svg-map"><g id="paths-container"></g></svg>
      </div>
    </div>

    <div id="editor-panel" onclick="event.stopPropagation()">
      <div class="panel-content">
        <h2 id="country-title" style="margin:0 0 10px 0; color:var(--accent)">Ülke</h2>
        <div id="group-pills"></div>
        <button class="btn-main" style="background:#333; margin-bottom:20px;" onclick="addGroup()">+ Yeni Örgüt Ekle</button>
        
        <div id="edit-form" style="display:none; border-top: 1px solid #333; padding-top:15px;">
           <label class="field-label">ÖRGÜT ADI</label>
           <input type="text" id="org-name" class="input-text">
           
           <div style="display:flex; gap:10px;">
             <div style="flex:1">
               <label class="field-label">KATEGORİ</label>
               <div class="choice-grid" id="cat-btns">
                 <div class="choice-btn" onclick="setTemp('kategori','Cihatçı')">Cihatçı</div>
                 <div class="choice-btn" onclick="setTemp('kategori','Ayrılıkçı')">Ayrılıkçı</div>
                 <div class="choice-btn" onclick="setTemp('kategori','Devrimci')">Devrimci</div>
                 <div class="choice-btn" onclick="setTemp('kategori','Diğer')">Diğer</div>
               </div>
             </div>
             <div style="flex:1">
               <label class="field-label">DURUM</label>
               <div class="choice-grid" id="stat-btns">
                 <div class="choice-btn" data-val="Aktif" onclick="setTemp('durum','Aktif')">Aktif</div>
                 <div class="choice-btn" data-val="Pasif" onclick="setTemp('durum','Pasif')">Pasif</div>
                 <div class="choice-btn" data-val="Bilinmiyor" onclick="setTemp('durum','Bilinmiyor')">Bilinmiyor</div>
               </div>
             </div>
           </div>

           <div class="tabs" id="tab-bar"></div>
           <div id="editor" class="rich-editor" contenteditable="true"></div>
           
           <button class="btn-main" onclick="applyChanges()">ÖRGÜTÜ KAYDET (HAFIZAYA AL)</button>
           <button style="background:none; border:none; color:var(--pasif); cursor:pointer; margin-top:15px; font-size:11px; width:100%; text-align:center;" onclick="deleteOrg()">Bu Örgütü Tamamen Sil</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let data = {};
let curC = null, curG = null, curT = 0;
const keys = ["olusum_sureci", "nihai_hedef", "yonetim_yapisi", "eylem_metotlari", "eylemler", "finansman_kaynaklari", "grup_iliskileri", "diger_bilgiler", "kaynakca"];
const tabLabels = ["Oluşum", "Hedef", "Yönetim", "Metot", "Eylemler", "Finans", "İlişkiler", "Bilgi", "Kaynak"];

function init() {
  const container = document.getElementById('paths-container');
  // ÖNEMLİ: Harita pathlerinizi buraya yapıştırın
  container.innerHTML = `
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>MİLİTAN ATLASI | ADMİN PANEL PRO</title>
  <style>
    :root { 
      --bg-body: #111; --bg-map: #1a1a1a; --accent: #3b82f6;
      --sidebar-bg: #181818; --text-main: #eee; --text-dim: #aaa;
      --aktif: #10b981; --pasif: #ef4444; --bilinmiyor: #6b7280;
    }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg-body); color: var(--text-main); margin: 0; overflow: hidden; height: 100vh; }
    #app { display: flex; flex-direction: column; height: 100vh; }
    
    /* HEADER & STATS */
    #header { height: 60px; background: #000; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000; }
    #stats-bar { background: #0a0a0a; padding: 8px 20px; display: flex; gap: 15px; font-size: 11px; border-bottom: 1px solid #222; color: var(--text-dim); }
    .stat-item b { color: #fff; background: #333; padding: 2px 6px; border-radius: 3px; margin-left: 4px; }

    #main { display: flex; flex: 1; position: relative; overflow: hidden; }

    /* SOL FİLTRE PANELİ */
    #filter-panel { width: 280px; background: #151515; border-right: 1px solid #222; display: flex; flex-direction: column; padding: 15px; overflow-y: auto; }
    .filter-btn { background: #222; border: 1px solid #333; color: #fff; padding: 10px; margin-bottom: 5px; border-radius: 5px; cursor: pointer; text-align: left; font-size: 12px; transition: 0.2s; }
    .filter-btn:hover { background: #333; }
    .filter-btn.active { border-color: var(--accent); background: #1e293b; }
    #filter-results { margin-top: 15px; }
    .result-item { padding: 10px; border-bottom: 1px solid #222; font-size: 13px; cursor: pointer; color: var(--text-dim); border-radius: 4px; }
    .result-item:hover { color: #fff; background: #222; }

    /* HARİTA ALANI */
    #map-container { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: var(--bg-map); overflow: hidden; }
    svg { width: 100%; height: 100%; transition: 0.3s; }
    /* Harita Beyaz Yapıldı */
    path { fill: #ffffff; stroke: #999; stroke-width: 0.3; transition: 0.2s; cursor: pointer; }
    path:hover { fill: #e2e8f0; stroke: var(--accent); }
    path.selected { fill: #cbd5e1 !important; stroke: var(--accent); stroke-width: 1.5; }

    /* SAĞ EDİTÖR PANELİ */
    #editor-panel {
      width: 500px; background: var(--sidebar-bg); border-left: 1px solid #333;
      position: absolute; right: 0; top: 0; bottom: 0; z-index: 2000;
      transform: translateX(100%); transition: transform 0.3s ease;
      display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.5);
    }
    #editor-panel.active { transform: translateX(0); }
    .panel-content { flex: 1; overflow-y: auto; padding: 25px; }

    .field-label { font-size: 10px; font-weight: bold; color: var(--text-dim); margin: 15px 0 5px; display: block; text-transform: uppercase; }
    .input-text { width: 100%; padding: 12px; background: #111; border: 1px solid #333; color: #fff; border-radius: 5px; box-sizing: border-box; font-size: 14px; }
    .choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
    .choice-btn { background: #222; border: 1px solid #333; color: var(--text-dim); padding: 8px; border-radius: 5px; cursor: pointer; font-size: 11px; text-align: center; }
    .choice-btn.active { border-color: var(--accent); color: #fff; background: #1e293b; }

    .tabs { display: flex; overflow-x: auto; gap: 5px; margin: 20px 0 10px; padding-bottom: 5px; border-bottom: 1px solid #222; }
    .tab-btn { background: #222; color: var(--text-dim); border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 11px; white-space: nowrap; }
    .tab-btn.active { background: var(--accent); color: #fff; }

    .rich-editor { min-height: 280px; background: #0a0a0a; border: 1px solid #333; border-radius: 5px; padding: 15px; outline: none; line-height: 1.6; font-size: 14px; overflow-y: auto; color: #ddd; }
    
    .pill { display: inline-block; padding: 6px 14px; background: #222; margin: 3px; border-radius: 4px; font-size: 12px; cursor: pointer; border: 1px solid #333; color: #fff; }
    .pill.active { background: var(--accent); border-color: var(--accent); }

    .btn-main { background: var(--accent); color: #fff; border: none; padding: 14px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 15px; font-size: 13px; }
    .btn-main:hover { background: #2563eb; }

    #tooltip { position: absolute; pointer-events: none; background: #000; color: #fff; padding: 5px 10px; border-radius: 4px; display: none; z-index: 3000; border: 1px solid #444; font-size: 11px; }
  </style>
</head>
<body onload="init()">

<div id="app">
  <div id="header">
    <div style="font-weight: bold; letter-spacing: 1px; font-size: 18px;">MİLİTAN ATLASI <span style="color:var(--accent)">EDITOR</span></div>
    <div>
      <input type="file" id="load-file" style="display:none" onchange="handleFile(this)">
      <button class="choice-btn" style="padding: 8px 15px;" onclick="document.getElementById('load-file').click()">JSON YÜKLE</button>
      <button class="choice-btn" style="padding: 8px 15px; margin-left: 10px; background: #333; color: #fff; border:none;" onclick="saveJSON()">JSON İNDİR (DOSYA)</button>
    </div>
  </div>

  <div id="stats-bar">
    <div class="stat-item">Toplam: <b id="st-total">0</b></div>
    <div class="stat-item">Cihatçı: <b id="st-cihat">0</b></div>
    <div class="stat-item">Ayrılıkçı: <b id="st-ayri">0</b></div>
    <div class="stat-item">Devrimci: <b id="st-devrim">0</b></div>
    <div class="stat-item">Diğer: <b id="st-diger">0</b></div>
    <div style="flex:1"></div>
    <div class="stat-item">Aktif: <b id="st-aktif" style="background:var(--aktif)">0</b></div>
    <div class="stat-item">Pasif: <b id="st-pasif" style="background:var(--pasif)">0</b></div>
  </div>

  <div id="main">
    <div id="filter-panel">
      <div class="field-label">Kategori Filtresi</div>
      <button class="filter-btn active" onclick="filterBy('Tümü', this)">Tüm Gruplar</button>
      <button class="filter-btn" onclick="filterBy('Cihatçı', this)">Cihatçı Örgütler</button>
      <button class="filter-btn" onclick="filterBy('Ayrılıkçı', this)">Ayrılıkçı Örgütler</button>
      <button class="filter-btn" onclick="filterBy('Devrimci', this)">Devrimci Örgütler</button>
      <button class="filter-btn" onclick="filterBy('Diğer', this)">Diğer</button>
      
      <div id="filter-results"></div>
    </div>

    <div id="map-container" onclick="closePanel()">
      <div id="tooltip"></div>
      <div id="map-wrapper">
        <svg id="svg-map"><g id="paths-container"></g></svg>
      </div>
    </div>

    <div id="editor-panel" onclick="event.stopPropagation()">
      <div class="panel-content">
        <h2 id="country-title" style="margin:0 0 10px 0; color:var(--accent)">Ülke</h2>
        <div id="group-pills"></div>
        <button class="btn-main" style="background:#333; margin-bottom:20px;" onclick="addGroup()">+ Yeni Örgüt Ekle</button>
        
        <div id="edit-form" style="display:none; border-top: 1px solid #333; padding-top:15px;">
           <label class="field-label">ÖRGÜT ADI</label>
           <input type="text" id="org-name" class="input-text">
           
           <div style="display:flex; gap:10px;">
             <div style="flex:1">
               <label class="field-label">KATEGORİ</label>
               <div class="choice-grid" id="cat-btns">
                 <div class="choice-btn" onclick="setTemp('kategori','Cihatçı')">Cihatçı</div>
                 <div class="choice-btn" onclick="setTemp('kategori','Ayrılıkçı')">Ayrılıkçı</div>
                 <div class="choice-btn" onclick="setTemp('kategori','Devrimci')">Devrimci</div>
                 <div class="choice-btn" onclick="setTemp('kategori','Diğer')">Diğer</div>
               </div>
             </div>
             <div style="flex:1">
               <label class="field-label">DURUM</label>
               <div class="choice-grid" id="stat-btns">
                 <div class="choice-btn" data-val="Aktif" onclick="setTemp('durum','Aktif')">Aktif</div>
                 <div class="choice-btn" data-val="Pasif" onclick="setTemp('durum','Pasif')">Pasif</div>
                 <div class="choice-btn" data-val="Bilinmiyor" onclick="setTemp('durum','Bilinmiyor')">Bilinmiyor</div>
               </div>
             </div>
           </div>

           <div class="tabs" id="tab-bar"></div>
           <div id="editor" class="rich-editor" contenteditable="true"></div>
           
           <button class="btn-main" onclick="applyChanges()">ÖRGÜTÜ KAYDET (HAFIZAYA AL)</button>
           <button style="background:none; border:none; color:var(--pasif); cursor:pointer; margin-top:15px; font-size:11px; width:100%; text-align:center;" onclick="deleteOrg()">Bu Örgütü Tamamen Sil</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let data = {};
let curC = null, curG = null, curT = 0;
const keys = ["olusum_sureci", "nihai_hedef", "yonetim_yapisi", "eylem_metotlari", "eylemler", "finansman_kaynaklari", "grup_iliskileri", "diger_bilgiler", "kaynakca"];
const tabLabels = ["Oluşum", "Hedef", "Yönetim", "Metot", "Eylemler", "Finans", "İlişkiler", "Bilgi", "Kaynak"];

function init() {
  const container = document.getElementById('paths-container');
  // ÖNEMLİ: Harita pathlerinizi buraya yapıştırın
  container.innerHTML = `<path id="TR" d="M 610,210 L 690,210 L 690,250 L 610,250 Z" />`; 

  fitMap();
  
  document.querySelectorAll('path').forEach(p => {
    p.onclick = (e) => { e.stopPropagation(); openCountry(p.id); };
    p.onmouseenter = (e) => showTip(e, p.id);
    p.onmousemove = moveTip;
    p.onmouseleave = hideTip;
  });

  tabLabels.forEach((l, i) => {
    const btn = document.createElement('button');
    btn.className = 'tab-btn' + (i===0?' active':'');
    btn.innerText = l;
    btn.onclick = () => { curT = i; updateTabs(); };
    document.getElementById('tab-bar').appendChild(btn);
  });
}

function filterBy(cat, el) {
    if(el) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }
    const results = document.getElementById('filter-results');
    results.innerHTML = "";
    let list = [];

    Object.keys(data).forEach(countryId => {
        data[countryId].groups.forEach((g, idx) => {
            // "Diğer" filtresi için kategori kontrolü düzeltildi
            if(cat === 'Tümü' || g.kategori === cat) {
                list.push({ ...g, cid: countryId, gidx: idx });
            }
        });
    });

    list.sort((a,b) => a.name_tr.localeCompare(b.name_tr));

    list.forEach(item => {
        const d = document.createElement('div');
        d.className = 'result-item';
        d.innerHTML = `<b>${item.name_tr}</b> <small style="color:#666">| ${item.cid}</small>`;
        d.onclick = () => { openCountry(item.cid); loadGroup(item.gidx); };
        results.appendChild(d);
    });
}

function openCountry(id) {
  curC = id; curG = null;
  document.querySelectorAll('path').forEach(p => p.classList.remove('selected'));
  if(document.getElementById(id)) document.getElementById(id).classList.add('selected');
  document.getElementById('country-title').innerText = id;
  document.getElementById('editor-panel').classList.add('active');
  document.getElementById('edit-form').style.display = 'none';
  renderPills();
}

function loadGroup(idx) {
  curG = idx;
  const g = data[curC].groups[curG];
  document.getElementById('edit-form').style.display = 'block';
  document.getElementById('org-name').value = g.name_tr || "";
  refreshVisuals(g);
  updateTabs();
  renderPills();
}

function setTemp(field, val) {
    const selector = field === 'kategori' ? '#cat-btns .choice-btn' : '#stat-btns .choice-btn';
    document.querySelectorAll(selector).forEach(b => {
        const bVal = field === 'kategori' ? b.innerText : b.getAttribute('data-val');
        b.classList.toggle('active', bVal === val);
    });
}

function applyChanges() {
    if(!curC || curG === null) return;
    const g = data[curC].groups[curG];
    
    // Hafızaya yazma işlemi
    g.name_tr = document.getElementById('org-name').value;
    const activeCat = document.querySelector('#cat-btns .choice-btn.active');
    g.kategori = activeCat ? activeCat.innerText : "Diğer";
    const activeStat = document.querySelector('#stat-btns .choice-btn.active');
    g.durum = activeStat ? activeStat.getAttribute('data-val') : "Bilinmiyor";
    g[keys[curT]] = document.getElementById('editor').innerHTML;
    
    updateStats();
    // Filtre listesini güncelle
    const currentFilter = document.querySelector('.filter-btn.active').innerText.split(' ')[0];
    filterBy(currentFilter === "Tüm" ? "Tümü" : currentFilter);
    alert("Örgüt bilgileri başarıyla hafızaya kaydedildi. Kalıcı olması için 'JSON İNDİR' butonunu kullanmayı unutmayın.");
}

function updateTabs() {
    document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === curT));
    document.getElementById('editor').innerHTML = data[curC].groups[curG][keys[curT]] || "";
}

function refreshVisuals(g) {
    document.querySelectorAll('#cat-btns .choice-btn').forEach(b => b.classList.toggle('active', b.innerText === g.kategori));
    document.querySelectorAll('#stat-btns .choice-btn').forEach(b => b.classList.toggle('active', b.getAttribute('data-val') === g.durum));
}

function addGroup() {
  if(!data[curC]) data[curC] = { groups: [] };
  const g = { name_tr: "Yeni Örgüt", kategori: "Diğer", durum: "Bilinmiyor" };
  keys.forEach(k => g[k] = "");
  data[curC].groups.push(g);
  loadGroup(data[curC].groups.length - 1);
  updateStats();
}

function deleteOrg() {
    if(confirm("Bu örgütü silmek istediğinizden emin misiniz?")) {
        data[curC].groups.splice(curG, 1);
        curG = null;
        document.getElementById('edit-form').style.display = 'none';
        renderPills();
        updateStats();
        filterBy('Tümü');
    }
}

function updateStats() {
  let s = { total:0, cihat:0, ayri:0, devrim:0, diger:0, aktif:0, pasif:0 };
  Object.values(data).forEach(c => {
    (c.groups || []).forEach(g => {
      s.total++;
      if(g.kategori === 'Cihatçı') s.cihat++;
      else if(g.kategori === 'Ayrılıkçı') s.ayri++;
      else if(g.kategori === 'Devrimci') s.devrim++;
      else s.diger++;
      if(g.durum === 'Aktif') s.aktif++;
      else if(g.durum === 'Pasif') s.pasif++;
    });
  });
  document.getElementById('st-total').innerText = s.total;
  document.getElementById('st-cihat').innerText = s.cihat;
  document.getElementById('st-ayri').innerText = s.ayri;
  document.getElementById('st-devrim').innerText = s.devrim;
  document.getElementById('st-diger').innerText = s.diger;
  document.getElementById('st-aktif').innerText = s.aktif;
  document.getElementById('st-pasif').innerText = s.pasif;
}

function renderPills() {
  const box = document.getElementById('group-pills');
  box.innerHTML = "";
  (data[curC]?.groups || []).forEach((g, i) => {
    const p = document.createElement('div');
    p.className = 'pill' + (curG === i ? ' active' : '');
    p.innerText = g.name_tr;
    p.onclick = () => loadGroup(i);
    box.appendChild(p);
  });
}

function fitMap() {
  const svg = document.getElementById('svg-map');
  const b = document.getElementById('paths-container').getBBox();
  // Haritayı merkeze alan ve yaklaştıran yeni zoom ayarı
  if(b.width > 0) {
      const pad = 5; 
      svg.setAttribute("viewBox", `${b.x - pad} ${b.y - pad} ${b.width + pad*2} ${b.height + pad*2}`);
  }
}

function handleFile(input) {
  const reader = new FileReader();
  reader.onload = () => { 
      data = JSON.parse(reader.result); 
      updateStats(); 
      filterBy('Tümü'); 
      fitMap(); 
      alert("Dosya başarıyla yüklendi."); 
  };
  reader.readAsText(input.files[0]);
}

function saveJSON() {
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "militan_data_guncel.json";
  a.click();
}

function closePanel() {
  document.getElementById('editor-panel').classList.remove('active');
  document.querySelectorAll('path').forEach(p => p.classList.remove('selected'));
}
function showTip(e, id) {
  const tip = document.getElementById('tooltip');
  tip.innerText = id + " | " + (data[id]?.groups?.length || 0) + " Örgüt";
  tip.style.display = 'block';
}
function moveTip(e) {
  const tip = document.getElementById('tooltip');
  tip.style.left = (e.pageX + 10) + 'px'; tip.style.top = (e.pageY + 10) + 'px';
}
function hideTip() { document.getElementById('tooltip').style.display = 'none'; }
window.onkeydown = (e) => { if(e.key === "Escape") closePanel(); };
</script>
</body>
</html>  `; 

  fitMap();
  
  document.querySelectorAll('path').forEach(p => {
    p.onclick = (e) => { e.stopPropagation(); openCountry(p.id); };
    p.onmouseenter = (e) => showTip(e, p.id);
    p.onmousemove = moveTip;
    p.onmouseleave = hideTip;
  });

  tabLabels.forEach((l, i) => {
    const btn = document.createElement('button');
    btn.className = 'tab-btn' + (i===0?' active':'');
    btn.innerText = l;
    btn.onclick = () => { curT = i; updateTabs(); };
    document.getElementById('tab-bar').appendChild(btn);
  });
}

function filterBy(cat, el) {
    if(el) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }
    const results = document.getElementById('filter-results');
    results.innerHTML = "";
    let list = [];

    Object.keys(data).forEach(countryId => {
        data[countryId].groups.forEach((g, idx) => {
            // "Diğer" filtresi için kategori kontrolü düzeltildi
            if(cat === 'Tümü' || g.kategori === cat) {
                list.push({ ...g, cid: countryId, gidx: idx });
            }
        });
    });

    list.sort((a,b) => a.name_tr.localeCompare(b.name_tr));

    list.forEach(item => {
        const d = document.createElement('div');
        d.className = 'result-item';
        d.innerHTML = `<b>${item.name_tr}</b> <small style="color:#666">| ${item.cid}</small>`;
        d.onclick = () => { openCountry(item.cid); loadGroup(item.gidx); };
        results.appendChild(d);
    });
}

function openCountry(id) {
  curC = id; curG = null;
  document.querySelectorAll('path').forEach(p => p.classList.remove('selected'));
  if(document.getElementById(id)) document.getElementById(id).classList.add('selected');
  document.getElementById('country-title').innerText = id;
  document.getElementById('editor-panel').classList.add('active');
  document.getElementById('edit-form').style.display = 'none';
  renderPills();
}

function loadGroup(idx) {
  curG = idx;
  const g = data[curC].groups[curG];
  document.getElementById('edit-form').style.display = 'block';
  document.getElementById('org-name').value = g.name_tr || "";
  refreshVisuals(g);
  updateTabs();
  renderPills();
}

function setTemp(field, val) {
    const selector = field === 'kategori' ? '#cat-btns .choice-btn' : '#stat-btns .choice-btn';
    document.querySelectorAll(selector).forEach(b => {
        const bVal = field === 'kategori' ? b.innerText : b.getAttribute('data-val');
        b.classList.toggle('active', bVal === val);
    });
}

function applyChanges() {
    if(!curC || curG === null) return;
    const g = data[curC].groups[curG];
    
    // Hafızaya yazma işlemi
    g.name_tr = document.getElementById('org-name').value;
    const activeCat = document.querySelector('#cat-btns .choice-btn.active');
    g.kategori = activeCat ? activeCat.innerText : "Diğer";
    const activeStat = document.querySelector('#stat-btns .choice-btn.active');
    g.durum = activeStat ? activeStat.getAttribute('data-val') : "Bilinmiyor";
    g[keys[curT]] = document.getElementById('editor').innerHTML;
    
    updateStats();
    // Filtre listesini güncelle
    const currentFilter = document.querySelector('.filter-btn.active').innerText.split(' ')[0];
    filterBy(currentFilter === "Tüm" ? "Tümü" : currentFilter);
    alert("Örgüt bilgileri başarıyla hafızaya kaydedildi. Kalıcı olması için 'JSON İNDİR' butonunu kullanmayı unutmayın.");
}

function updateTabs() {
    document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === curT));
    document.getElementById('editor').innerHTML = data[curC].groups[curG][keys[curT]] || "";
}

function refreshVisuals(g) {
    document.querySelectorAll('#cat-btns .choice-btn').forEach(b => b.classList.toggle('active', b.innerText === g.kategori));
    document.querySelectorAll('#stat-btns .choice-btn').forEach(b => b.classList.toggle('active', b.getAttribute('data-val') === g.durum));
}

function addGroup() {
  if(!data[curC]) data[curC] = { groups: [] };
  const g = { name_tr: "Yeni Örgüt", kategori: "Diğer", durum: "Bilinmiyor" };
  keys.forEach(k => g[k] = "");
  data[curC].groups.push(g);
  loadGroup(data[curC].groups.length - 1);
  updateStats();
}

function deleteOrg() {
    if(confirm("Bu örgütü silmek istediğinizden emin misiniz?")) {
        data[curC].groups.splice(curG, 1);
        curG = null;
        document.getElementById('edit-form').style.display = 'none';
        renderPills();
        updateStats();
        filterBy('Tümü');
    }
}

function updateStats() {
  let s = { total:0, cihat:0, ayri:0, devrim:0, diger:0, aktif:0, pasif:0 };
  Object.values(data).forEach(c => {
    (c.groups || []).forEach(g => {
      s.total++;
      if(g.kategori === 'Cihatçı') s.cihat++;
      else if(g.kategori === 'Ayrılıkçı') s.ayri++;
      else if(g.kategori === 'Devrimci') s.devrim++;
      else s.diger++;
      if(g.durum === 'Aktif') s.aktif++;
      else if(g.durum === 'Pasif') s.pasif++;
    });
  });
  document.getElementById('st-total').innerText = s.total;
  document.getElementById('st-cihat').innerText = s.cihat;
  document.getElementById('st-ayri').innerText = s.ayri;
  document.getElementById('st-devrim').innerText = s.devrim;
  document.getElementById('st-diger').innerText = s.diger;
  document.getElementById('st-aktif').innerText = s.aktif;
  document.getElementById('st-pasif').innerText = s.pasif;
}

function renderPills() {
  const box = document.getElementById('group-pills');
  box.innerHTML = "";
  (data[curC]?.groups || []).forEach((g, i) => {
    const p = document.createElement('div');
    p.className = 'pill' + (curG === i ? ' active' : '');
    p.innerText = g.name_tr;
    p.onclick = () => loadGroup(i);
    box.appendChild(p);
  });
}

function fitMap() {
  const svg = document.getElementById('svg-map');
  const b = document.getElementById('paths-container').getBBox();
  // Haritayı merkeze alan ve yaklaştıran yeni zoom ayarı
  if(b.width > 0) {
      const pad = 5; 
      svg.setAttribute("viewBox", `${b.x - pad} ${b.y - pad} ${b.width + pad*2} ${b.height + pad*2}`);
  }
}

function handleFile(input) {
  const reader = new FileReader();
  reader.onload = () => { 
      data = JSON.parse(reader.result); 
      updateStats(); 
      filterBy('Tümü'); 
      fitMap(); 
      alert("Dosya başarıyla yüklendi."); 
  };
  reader.readAsText(input.files[0]);
}

function saveJSON() {
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "militan_data_guncel.json";
  a.click();
}

function closePanel() {
  document.getElementById('editor-panel').classList.remove('active');
  document.querySelectorAll('path').forEach(p => p.classList.remove('selected'));
}
function showTip(e, id) {
  const tip = document.getElementById('tooltip');
  tip.innerText = id + " | " + (data[id]?.groups?.length || 0) + " Örgüt";
  tip.style.display = 'block';
}
function moveTip(e) {
  const tip = document.getElementById('tooltip');
  tip.style.left = (e.pageX + 10) + 'px'; tip.style.top = (e.pageY + 10) + 'px';
}
function hideTip() { document.getElementById('tooltip').style.display = 'none'; }
window.onkeydown = (e) => { if(e.key === "Escape") closePanel(); };
</script>
</body>
</html>
