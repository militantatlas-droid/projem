<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>MİLİTAN ATLASI | YAZAR PANELİ PRO</title>
  <style>
    :root { 
      --accent: #3b82f6; --bg-dark: #121212; --panel-bg: #ffffff; 
      --map-land: #ffffff; --map-stroke: #cbd5e1; --text-main: #1e293b;
      --aktif: #10b981; --pasif: #ef4444; --bilinmiyor: #6b7280;
    }
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg-dark); color: #fff; margin: 0; overflow: hidden; height: 100vh; }
    #app { display: flex; flex-direction: column; height: 100vh; }
    
    /* HEADER & STATS */
    #header { height: 60px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000; }
    #stats-bar { background: #1e1e1e; padding: 8px 20px; display: flex; flex-wrap: wrap; gap: 15px; font-size: 11px; border-bottom: 1px solid #333; color: #aaa; text-transform: uppercase; }
    .stat-item b { color: #fff; background: #333; padding: 2px 6px; border-radius: 4px; margin-left: 4px; }

    #main { display: flex; flex: 1; position: relative; overflow: hidden; }
    #map-container { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; cursor: crosshair; }
    svg { width: 100%; height: 100%; }
    path { fill: var(--map-land); stroke: var(--map-stroke); stroke-width: 0.5; transition: 0.2s; cursor: pointer; }
    path:hover { fill: #f1f5f9; stroke: var(--accent); }
    path.selected { fill: #e0f2fe; stroke: var(--accent); stroke-width: 1.5; }

    /* SIDEBAR PANEL */
    #editor-panel {
      width: 550px; background: var(--panel-bg); color: var(--text-main);
      position: absolute; right: 0; top: 0; bottom: 0; z-index: 2000;
      transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: -10px 0 30px rgba(0,0,0,0.5); display: flex; flex-direction: column;
    }
    #editor-panel.active { transform: translateX(0); }
    .panel-content { flex: 1; overflow-y: auto; padding: 25px; }

    /* UI ELEMENTS */
    .selector-label { font-size: 10px; font-weight: 800; color: #64748b; margin: 15px 0 5px 0; display: block; text-transform: uppercase; }
    .btn-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 6px; }
    .choice-btn { padding: 10px; border: 1px solid #ddd; background: #f8fafc; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; text-align: center; color: #475569; transition: 0.2s; }
    
    /* Active States */
    .choice-btn.active[data-type="cat"] { background: var(--accent); color: #fff; border-color: var(--accent); }
    .choice-btn.active[data-val="Aktif"] { background: var(--aktif); color: #fff; border-color: var(--aktif); }
    .choice-btn.active[data-val="Pasif"] { background: var(--pasif); color: #fff; border-color: var(--pasif); }
    .choice-btn.active[data-val="Bilinmiyor"] { background: var(--bilinmiyor); color: #fff; border-color: var(--bilinmiyor); }

    .tabs { display: flex; flex-wrap: wrap; gap: 4px; margin: 20px 0 10px 0; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
    .tab-btn { padding: 7px 12px; font-size: 11px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 4px; cursor: pointer; font-weight: 600; color: #64748b; }
    .tab-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    .rich-editor { min-height: 300px; background: #fff; border: 2px solid #f1f5f9; border-radius: 8px; padding: 15px; outline: none; line-height: 1.6; color: #1e293b; font-size: 14px; overflow-y: auto; }
    .rich-editor:focus { border-color: var(--accent); }

    .pill { display: inline-block; padding: 6px 12px; background: #f1f5f9; margin: 3px; border-radius: 20px; font-size: 12px; cursor: pointer; border: 1px solid #cbd5e1; font-weight: 600; color: #475569; }
    .pill.active { background: #1e293b; color: #fff; border-color: #1e293b; }

    .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn:active { transform: scale(0.98); }
    
    #tooltip { position: absolute; pointer-events: none; background: #fff; color: #000; padding: 8px 12px; border-radius: 6px; display: none; z-index: 3000; border: 1px solid var(--accent); font-size: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
  </style>
</head>
<body onload="init()">

<div id="app">
  <div id="header">
    <div style="font-weight: 900; color:#fff; letter-spacing: 1px;">MİLİTAN ATLASI <span style="color:var(--accent)">// YAZAR PANELİ</span></div>
    <div>
      <input type="file" id="load-file" style="display:none" onchange="handleFile(this)">
      <button class="btn" style="background:#334155; color:#fff;" onclick="document.getElementById('load-file').click()">VERİ YÜKLE (JSON)</button>
      <button class="btn" style="background:var(--accent); color:#fff; margin-left:10px;" onclick="saveJSON()">DEĞİŞİKLİKLERİ KAYDET</button>
    </div>
  </div>

  <div id="stats-bar">
    <div class="stat-item">Toplam Grup: <b id="st-total">0</b></div>
    <div class="stat-item">Cihatçı: <b id="st-cihat">0</b></div>
    <div class="stat-item">Ayrılıkçı: <b id="st-ayri">0</b></div>
    <div class="stat-item">Devrimci: <b id="st-devrim">0</b></div>
    <div class="stat-item" style="color:var(--aktif)">Aktif: <b id="st-aktif">0</b></div>
    <div class="stat-item" style="color:var(--pasif)">Pasif: <b id="st-pasif">0</b></div>
  </div>

  <div id="main">
    <div id="map-container" onclick="closePanel()">
      <div id="tooltip"></div>
      <div id="map-wrapper">
        <svg id="svg-map"><g id="paths-container"></g></svg>
      </div>
    </div>

    <div id="editor-panel" onclick="event.stopPropagation()">
      <div class="panel-content">
        <h2 id="country-title" style="margin-top:0; color:#0f172a; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">Ülke Seçiniz</h2>
        
        <label class="selector-label">ÜLKEDEKİ GRUPLAR</label>
        <div id="group-pills" style="margin-bottom: 15px;"></div>
        
        <button class="btn" style="background:#10b981; color:#fff; width:100%; margin-bottom:25px;" onclick="addGroup()">+ YENİ ÖRGÜT EKLE</button>
        
        <div id="edit-form" style="display:none; border-top: 1px solid #e2e8f0; padding-top: 10px;">
           <label class="selector-label">ÖRGÜT ADI</label>
           <input type="text" id="org-name" style="width:100%; padding:12px; margin-bottom:10px; border:2px solid #f1f5f9; border-radius:8px; font-weight:bold; font-size:16px;" placeholder="Örgüt ismini girin..." oninput="sync()">
           
           <label class="selector-label">İDEOLOJİK KATEGORİ</label>
           <div class="btn-grid" id="cat-selector">
             <div class="choice-btn" data-type="cat" onclick="setVal('kategori', 'Cihatçı')">Cihatçı</div>
             <div class="choice-btn" data-type="cat" onclick="setVal('kategori', 'Ayrılıkçı')">Ayrılıkçı</div>
             <div class="choice-btn" data-type="cat" onclick="setVal('kategori', 'Devrimci')">Devrimci</div>
             <div class="choice-btn" data-type="cat" onclick="setVal('kategori', 'Diğer')">Diğer</div>
           </div>

           <label class="selector-label">OPERASYONEL DURUM</label>
           <div class="btn-grid" id="status-selector">
             <div class="choice-btn" data-type="status" data-val="Aktif" onclick="setVal('durum', 'Aktif')">Aktif</div>
             <div class="choice-btn" data-type="status" data-val="Pasif" onclick="setVal('durum', 'Pasif')">Pasif</div>
             <div class="choice-btn" data-type="status" data-val="Bilinmiyor" onclick="setVal('durum', 'Bilinmiyor')">Bilinmiyor</div>
           </div>

           <div class="tabs" id="tab-bar"></div>
           
           <div style="margin-bottom: 5px; font-size: 11px; color: #94a3b8; font-style: italic;">İpucu: Metin girişi anlık olarak kaydedilir.</div>
           <div id="editor" class="rich-editor" contenteditable="true"></div>
           
           <button class="btn" style="background:#fff1f1; color:#ef4444; width:100%; margin-top:30px; border: 1px solid #fee2e2;" onclick="deleteOrg()">ÖRGÜTÜ KAYITLARDAN SİL</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let data = {};
let curC = null, curG = null, curT = 0;

// index (22).html ile birebir uyumlu anahtarlar
const keys = [
  "olusum_sureci", "nihai_hedef", "yonetim_yapisi", 
  "eylem_metotlari", "eylemler", "finansman_kaynaklari", 
  "grup_iliskileri", "diger_bilgiler", "kaynakca"
];

const tabNames = ["Oluşum", "Hedef", "Yönetim", "Taktik", "Eylemler", "Finans", "İlişkiler", "Bilgiler", "Kaynak"];

function init() {
  const container = document.getElementById('paths-container');
  
  // ÖNEMLİ: BURAYA KENDİ PATHLERİNİ YAPIŞTIR
  container.innerHTML = `
    <path id="TR" d="M 618,270 L 680,270 L 680,300 L 618,300 Z" />
    <path id="AO" d="M 480,580 L 520,580 L 520,620 L 480,620 Z" />
  `; 

  fitMap();
  
  document.querySelectorAll('path').forEach(p => {
    p.onclick = (e) => { e.stopPropagation(); openCountry(p.id); };
    p.onmouseenter = (e) => showTip(e, p.id);
    p.onmousemove = moveTip;
    p.onmouseleave = hideTip;
  });

  // Tab butonlarını oluştur
  tabNames.forEach((t, i) => {
    const btn = document.createElement('button');
    btn.className = 'tab-btn' + (i===0?' active':'');
    btn.innerText = t;
    btn.onclick = () => { curT = i; updateTabs(); };
    document.getElementById('tab-bar').appendChild(btn);
  });

  // Editör için anlık dinleyici
  const editor = document.getElementById('editor');
  editor.addEventListener('input', () => {
    if(curC && curG !== null) {
      data[curC].groups[curG][keys[curT]] = editor.innerHTML;
    }
  });
}

function updateTabs() {
  document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === curT));
  if(curC && curG !== null) {
    const g = data[curC].groups[curG];
    document.getElementById('editor').innerHTML = g[keys[curT]] || "";
  }
}

function setVal(field, val) {
  if(!curC || curG === null) return;
  data[curC].groups[curG][field] = val;
  updateStats();
  refreshUI();
}

function openCountry(id) {
  curC = id; curG = null;
  document.querySelectorAll('path').forEach(p => p.classList.remove('selected'));
  if(document.getElementById(id)) document.getElementById(id).classList.add('selected');
  document.getElementById('country-title').innerText = id + " Detayları";
  document.getElementById('editor-panel').classList.add('active');
  document.getElementById('edit-form').style.display = 'none';
  renderPills();
}

function loadGroup(idx) {
  curG = idx;
  const g = data[curC].groups[curG];
  document.getElementById('edit-form').style.display = 'block';
  document.getElementById('org-name').value = g.name_tr || "";
  
  refreshUI();
  updateTabs();
  renderPills();
}

function refreshUI() {
  if(curG === null) return;
  const g = data[curC].groups[curG];
  document.querySelectorAll('.choice-btn').forEach(b => {
    const isCat = b.getAttribute('data-type') === 'cat' && b.innerText === g.kategori;
    const isStatus = b.getAttribute('data-type') === 'status' && b.getAttribute('data-val') === g.durum;
    b.classList.toggle('active', isCat || isStatus);
  });
}

function sync() {
  if(curC && curG !== null) {
    data[curC].groups[curG].name_tr = document.getElementById('org-name').value;
    renderPills();
  }
}

function addGroup() {
  if(!data[curC]) data[curC] = { name_tr: curC, groups: [] };
  const newOrg = { name_tr: "Yeni Örgüt", kategori: "Diğer", durum: "Bilinmiyor" };
  // Tüm keyleri boş olarak tanımla (Hata vermemesi için)
  keys.forEach(k => newOrg[k] = "");
  
  data[curC].groups.push(newOrg);
  loadGroup(data[curC].groups.length - 1);
  updateStats();
}

function deleteOrg() {
  if(confirm("Bu örgütü silmek istediğinize emin misiniz?")) {
    data[curC].groups.splice(curG, 1);
    curG = null;
    document.getElementById('edit-form').style.display = 'none';
    renderPills();
    updateStats();
  }
}

function updateStats() {
  let stats = { total:0, cihat:0, ayri:0, devrim:0, aktif:0, pasif:0 };
  Object.values(data).forEach(c => {
    (c.groups || []).forEach(g => {
      stats.total++;
      if(g.kategori === 'Cihatçı') stats.cihat++;
      else if(g.kategori === 'Ayrılıkçı') stats.ayri++;
      else if(g.kategori === 'Devrimci') stats.devrim++;
      if(g.durum === 'Aktif') stats.aktif++;
      else if(g.durum === 'Pasif') stats.pasif++;
    });
  });
  document.getElementById('st-total').innerText = stats.total;
  document.getElementById('st-cihat').innerText = stats.cihat;
  document.getElementById('st-ayri').innerText = stats.ayri;
  document.getElementById('st-devrim').innerText = stats.devrim;
  document.getElementById('st-aktif').innerText = stats.aktif;
  document.getElementById('st-pasif').innerText = stats.pasif;
}

function fitMap() {
  const svg = document.getElementById('svg-map');
  const bBox = document.getElementById('paths-container').getBBox();
  const pad = 40;
  if(bBox.width > 0)
    svg.setAttribute("viewBox", `${bBox.x-pad} ${bBox.y-pad} ${bBox.width+pad*2} ${bBox.height+pad*2}`);
}

function closePanel() { 
  document.getElementById('editor-panel').classList.remove('active'); 
  document.querySelectorAll('path').forEach(p => p.classList.remove('selected'));
  curC = null; curG = null;
}

function renderPills() {
  const box = document.getElementById('group-pills');
  box.innerHTML = "";
  (data[curC]?.groups || []).forEach((g, i) => {
    const p = document.createElement('div');
    p.className = 'pill' + (curG === i ? ' active' : '');
    p.innerText = g.name_tr;
    p.onclick = () => loadGroup(i);
    box.appendChild(p);
  });
}

function handleFile(input) {
  const reader = new FileReader();
  reader.onload = () => { 
    try {
      data = JSON.parse(reader.result); 
      updateStats(); 
      alert("Veri başarıyla yüklendi."); 
    } catch(e) { alert("Hata: Geçersiz JSON dosyası!"); }
  };
  reader.readAsText(input.files[0]);
}

function saveJSON() {
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "militan_data.json";
  a.click();
}

function showTip(e, id) {
  const tip = document.getElementById('tooltip');
  const count = data[id]?.groups?.length || 0;
  tip.innerHTML = `<strong>${id}</strong><br>Grup Sayısı: ${count}`;
  tip.style.display = 'block';
}

function moveTip(e) {
  const tip = document.getElementById('tooltip');
  tip.style.left = (e.pageX + 15) + 'px'; tip.style.top = (e.pageY + 15) + 'px';
}

function hideTip() { document.getElementById('tooltip').style.display = 'none'; }
window.onkeydown = (e) => { if(e.key === "Escape") closePanel(); };
</script>
</body>
</html>
