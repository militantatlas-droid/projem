<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>MİLİTAN ATLASI | YAZAR PANELİ PRO</title>
  <style>
    :root { 
      --accent: #2563eb; --bg-dark: #0f172a; --panel-bg: #f8fafc; 
      --map-land: #ffffff; --map-stroke: #cbd5e1; --text-main: #1e293b;
      --aktif: #10b981; --pasif: #ef4444; --bilinmiyor: #64748b;
    }
    body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-dark); color: #fff; margin: 0; overflow: hidden; height: 100vh; }
    #app { display: flex; flex-direction: column; height: 100vh; }
    
    /* HEADER */
    #header { height: 65px; background: #1a1a1a; border-bottom: 1px solid #334155; display: flex; align-items: center; justify-content: space-between; padding: 0 25px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    #stats-bar { background: #1e293b; padding: 10px 25px; display: flex; flex-wrap: wrap; gap: 15px; font-size: 11px; border-bottom: 1px solid #334155; color: #94a3b8; letter-spacing: 0.5px; }
    .stat-item b { color: #fff; background: #334155; padding: 2px 7px; border-radius: 4px; margin-left: 5px; }

    /* MAIN AREA */
    #main { display: flex; flex: 1; position: relative; overflow: hidden; }
    #map-container { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle, #1e293b 0%, #0f172a 100%); overflow: hidden; }
    
    /* SVG'yi Büyütüyoruz */
    #map-wrapper { width: 95%; height: 95%; display: flex; align-items: center; justify-content: center; }
    svg { width: 100%; height: 100%; transition: transform 0.5s ease; }
    path { fill: var(--map-land); stroke: var(--map-stroke); stroke-width: 0.4; transition: 0.3s; cursor: pointer; }
    path:hover { fill: #f1f5f9; stroke: var(--accent); stroke-width: 1; }
    path.selected { fill: #dbeafe; stroke: var(--accent); stroke-width: 2; filter: drop-shadow(0 0 5px rgba(37,99,235,0.4)); }

    /* SIDEBAR MODERNIZE */
    #editor-panel {
      width: 500px; background: var(--panel-bg); color: var(--text-main);
      position: absolute; right: 0; top: 0; bottom: 0; z-index: 2000;
      transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: -15px 0 40px rgba(0,0,0,0.6); display: flex; flex-direction: column;
    }
    #editor-panel.active { transform: translateX(0); }
    .panel-content { flex: 1; overflow-y: auto; padding: 30px; scrollbar-width: thin; }

    .selector-label { font-size: 11px; font-weight: 700; color: #64748b; margin: 20px 0 8px 0; display: block; text-transform: uppercase; }
    .btn-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; }
    .choice-btn { padding: 12px; border: 1.5px solid #e2e8f0; background: #fff; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; text-align: center; color: #475569; transition: 0.2s; }
    
    .choice-btn.active[data-type="cat"] { background: var(--accent); color: #fff; border-color: var(--accent); }
    .choice-btn.active[data-val="Aktif"] { background: var(--aktif); color: #fff; border-color: var(--aktif); }
    .choice-btn.active[data-val="Pasif"] { background: var(--pasif); color: #fff; border-color: var(--pasif); }
    .choice-btn.active[data-val="Bilinmiyor"] { background: var(--bilinmiyor); color: #fff; border-color: var(--bilinmiyor); }

    .tabs { display: flex; overflow-x: auto; gap: 5px; margin: 25px 0 15px 0; padding-bottom: 5px; border-bottom: 1px solid #e2e8f0; }
    .tab-btn { padding: 8px 14px; font-size: 11px; background: #f1f5f9; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: #64748b; white-space: nowrap; }
    .tab-btn.active { background: var(--text-main); color: #fff; }

    .rich-editor { min-height: 280px; background: #fff; border: 1.5px solid #e2e8f0; border-radius: 10px; padding: 18px; outline: none; line-height: 1.7; color: #1e293b; font-size: 14px; }
    .rich-editor:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(37,99,235,0.1); }

    .pill { display: inline-block; padding: 7px 15px; background: #e2e8f0; margin: 4px; border-radius: 25px; font-size: 12px; cursor: pointer; border: 1px solid transparent; font-weight: 600; color: #475569; }
    .pill.active { background: var(--accent); color: #fff; }

    .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .save-group-btn { background: #2563eb; color: #fff; width: 100%; margin: 20px 0; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .save-group-btn:hover { background: #1d4ed8; }

    #tooltip { position: absolute; pointer-events: none; background: rgba(255,255,255,0.95); color: #000; padding: 10px 15px; border-radius: 8px; display: none; z-index: 3000; border: 1px solid #ddd; font-size: 13px; backdrop-filter: blur(4px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
  </style>
</head>
<body onload="init()">

<div id="app">
  <div id="header">
    <div style="font-weight: 900; color:#fff; font-size: 18px; letter-spacing: -0.5px;">MİLİTAN ATLASI <span style="color:var(--accent); font-weight: 300;">| Yazar Paneli</span></div>
    <div>
      <input type="file" id="load-file" style="display:none" onchange="handleFile(this)">
      <button class="btn" style="background:#334155; color:#fff; font-size:12px;" onclick="document.getElementById('load-file').click()">VERİ YÜKLE</button>
      <button class="btn" style="background:var(--accent); color:#fff; margin-left:10px; font-size:12px;" onclick="saveJSON()">TÜMÜNÜ İNDİR (JSON)</button>
    </div>
  </div>

  <div id="stats-bar">
    <div class="stat-item">GRUP: <b id="st-total">0</b></div>
    <div class="stat-item">CİHATÇI: <b id="st-cihat">0</b></div>
    <div class="stat-item">AYRILIKÇI: <b id="st-ayri">0</b></div>
    <div class="stat-item">DEVRİMCİ: <b id="st-devrim">0</b></div>
    <div class="stat-item" style="color:var(--aktif)">AKTİF: <b id="st-aktif">0</b></div>
    <div class="stat-item" style="color:var(--pasif)">PASİF: <b id="st-pasif">0</b></div>
  </div>

  <div id="main">
    <div id="map-container" onclick="closePanel()">
      <div id="tooltip"></div>
      <div id="map-wrapper">
        <svg id="svg-map"><g id="paths-container"></g></svg>
      </div>
    </div>

    <div id="editor-panel" onclick="event.stopPropagation()">
      <div class="panel-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 id="country-title" style="margin:0; font-size:24px; color:#0f172a;">Ülke</h2>
            <button onclick="closePanel()" style="background:none; border:none; cursor:pointer; font-size:20px;">✕</button>
        </div>
        
        <label class="selector-label">ÜLKEDEKİ ÖRGÜTLER</label>
        <div id="group-pills"></div>
        <button class="btn" style="background:#10b981; color:#fff; width:100%; margin: 15px 0; font-size:13px;" onclick="addGroup()">+ YENİ ÖRGÜT EKLE</button>
        
        <div id="edit-form" style="display:none; border-top: 2px solid #f1f5f9; margin-top: 10px;">
           <label class="selector-label">ÖRGÜT ADI</label>
           <input type="text" id="org-name" style="width:100%; padding:14px; box-sizing:border-box; border:1.5px solid #e2e8f0; border-radius:10px; font-weight:700; font-size:16px; color:#1e293b;" placeholder="İsim giriniz...">
           
           <label class="selector-label">İDEOLOJİ</label>
           <div class="btn-grid">
             <div class="choice-btn" data-type="cat" onclick="tempSet('kategori', 'Cihatçı')">Cihatçı</div>
             <div class="choice-btn" data-type="cat" onclick="tempSet('kategori', 'Ayrılıkçı')">Ayrılıkçı</div>
             <div class="choice-btn" data-type="cat" onclick="tempSet('kategori', 'Devrimci')">Devrimci</div>
             <div class="choice-btn" data-type="cat" onclick="tempSet('kategori', 'Diğer')">Diğer</div>
           </div>

           <label class="selector-label">DURUM</label>
           <div class="btn-grid">
             <div class="choice-btn" data-type="status" data-val="Aktif" onclick="tempSet('durum', 'Aktif')">Aktif</div>
             <div class="choice-btn" data-type="status" data-val="Pasif" onclick="tempSet('durum', 'Pasif')">Pasif</div>
             <div class="choice-btn" data-type="status" data-val="Bilinmiyor" onclick="tempSet('durum', 'Bilinmiyor')">Bilinmiyor</div>
           </div>

           <div class="tabs" id="tab-bar"></div>
           <div id="editor" class="rich-editor" contenteditable="true"></div>
           
           <button class="btn save-group-btn" onclick="applyChanges()">
             <span>✓ DEĞİŞİKLİKLERİ ÖRGÜTE UYGULA</span>
           </button>

           <button class="btn" style="background:none; color:#ef4444; width:100%; font-size:11px; font-weight:600; text-decoration:underline;" onclick="deleteOrg()">Örgütü Kayıtlardan Sil</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let data = {};
let curC = null, curG = null, curT = 0;
const keys = ["olusum_sureci", "nihai_hedef", "yonetim_yapisi", "eylem_metotlari", "eylemler", "finansman_kaynaklari", "grup_iliskileri", "diger_bilgiler", "kaynakca"];
const tabsArr = ["Oluşum", "Hedef", "Yönetim", "Taktik", "Eylemler", "Finans", "İlişkiler", "Bilgiler", "Kaynak"];

function init() {
  const container = document.getElementById('paths-container');
  // PATHLERİNİZİ BURAYA YAPIŞTIRIN
  container.innerHTML = `<path id="TR" d="M 610,210 L 690,210 L 690,250 L 610,250 Z" />`; 

  fitMap();
  
  document.querySelectorAll('path').forEach(p => {
    p.onclick = (e) => { e.stopPropagation(); openCountry(p.id); };
    p.onmouseenter = (e) => showTip(e, p.id);
    p.onmousemove = moveTip;
    p.onmouseleave = hideTip;
  });

  tabsArr.forEach((t, i) => {
    const btn = document.createElement('button');
    btn.className = 'tab-btn' + (i===0?' active':'');
    btn.innerText = t;
    btn.onclick = () => { curT = i; updateTabs(); };
    document.getElementById('tab-bar').appendChild(btn);
  });
}

function openCountry(id) {
  curC = id; curG = null;
  document.querySelectorAll('path').forEach(p => p.classList.remove('selected'));
  if(document.getElementById(id)) document.getElementById(id).classList.add('selected');
  document.getElementById('country-title').innerText = id;
  document.getElementById('editor-panel').classList.add('active');
  document.getElementById('edit-form').style.display = 'none';
  renderPills();
}

function loadGroup(idx) {
  curG = idx;
  const g = data[curC].groups[curG];
  document.getElementById('edit-form').style.display = 'block';
  document.getElementById('org-name').value = g.name_tr || "";
  refreshVisuals();
  updateTabs();
  renderPills();
}

// Görsel seçimleri formda gösterir (Hafızaya henüz yazmaz)
function tempSet(field, val) {
  if(curG === null) return;
  const btns = document.querySelectorAll(`.choice-btn[data-type="${field === 'kategori' ? 'cat' : 'status'}"]`);
  btns.forEach(b => {
    const isMatch = (field === 'kategori') ? (b.innerText === val) : (b.getAttribute('data-val') === val);
    b.classList.toggle('active', isMatch);
  });
}

// ÖRGÜTÜ KAYDET: Formdaki her şeyi JSON objesine yazar
function applyChanges() {
  if(!curC || curG === null) return;
  const g = data[curC].groups[curG];
  
  // İsim
  g.name_tr = document.getElementById('org-name').value;
  
  // Kategori
  const activeCat = document.querySelector('.choice-btn.active[data-type="cat"]');
  g.kategori = activeCat ? activeCat.innerText : "Diğer";
  
  // Durum
  const activeStat = document.querySelector('.choice-btn.active[data-type="status"]');
  g.durum = activeStat ? activeStat.getAttribute('data-val') : "Bilinmiyor";
  
  // Mevcut Tab İçeriği
  g[keys[curT]] = document.getElementById('editor').innerHTML;

  alert("Değişiklikler Örgüte Uygulandı!");
  renderPills();
  updateStats();
}

function updateTabs() {
  document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === curT));
  if(curC && curG !== null) {
    document.getElementById('editor').innerHTML = data[curC].groups[curG][keys[curT]] || "";
  }
}

function refreshVisuals() {
  const g = data[curC].groups[curG];
  document.querySelectorAll('.choice-btn').forEach(b => {
    const isCat = b.getAttribute('data-type') === 'cat' && b.innerText === g.kategori;
    const isStatus = b.getAttribute('data-type') === 'status' && b.getAttribute('data-val') === g.durum;
    b.classList.toggle('active', isCat || isStatus);
  });
}

function addGroup() {
  if(!data[curC]) data[curC] = { groups: [] };
  const g = { name_tr: "Yeni Örgüt", kategori: "Diğer", durum: "Bilinmiyor" };
  keys.forEach(k => g[k] = "");
  data[curC].groups.push(g);
  loadGroup(data[curC].groups.length - 1);
}

function renderPills() {
  const box = document.getElementById('group-pills');
  box.innerHTML = "";
  (data[curC]?.groups || []).forEach((g, i) => {
    const p = document.createElement('div');
    p.className = 'pill' + (curG === i ? ' active' : '');
    p.innerText = g.name_tr;
    p.onclick = () => loadGroup(i);
    box.appendChild(p);
  });
}

function updateStats() {
  let s = { total:0, cihat:0, ayri:0, devrim:0, aktif:0, pasif:0 };
  Object.values(data).forEach(c => {
    (c.groups || []).forEach(g => {
      s.total++;
      if(g.kategori === 'Cihatçı') s.cihat++;
      else if(g.kategori === 'Ayrılıkçı') s.ayri++;
      else if(g.kategori === 'Devrimci') s.devrim++;
      if(g.durum === 'Aktif') s.aktif++;
      else if(g.durum === 'Pasif') s.pasif++;
    });
  });
  document.getElementById('st-total').innerText = s.total;
  document.getElementById('st-cihat').innerText = s.cihat;
  document.getElementById('st-ayri').innerText = s.ayri;
  document.getElementById('st-devrim').innerText = s.devrim;
  document.getElementById('st-aktif').innerText = s.aktif;
  document.getElementById('st-pasif').innerText = s.pasif;
}

function fitMap() {
  const svg = document.getElementById('svg-map');
  const b = document.getElementById('paths-container').getBBox();
  if(b.width > 0) {
    const pad = 10;
    svg.setAttribute("viewBox", `${b.x - pad} ${b.y - pad} ${b.width + pad*2} ${b.height + pad*2}`);
  }
}

function closePanel() {
  document.getElementById('editor-panel').classList.remove('active');
  document.querySelectorAll('path').forEach(p => p.classList.remove('selected'));
  curC = null; curG = null;
}

function handleFile(input) {
  const reader = new FileReader();
  reader.onload = () => { data = JSON.parse(reader.result); updateStats(); alert("Veritabanı Yüklendi!"); };
  reader.readAsText(input.files[0]);
}

function saveJSON() {
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "militan_data.json";
  a.click();
}

function deleteOrg() {
    if(confirm("Bu örgüt kalıcı olarak silinecek?")) {
        data[curC].groups.splice(curG, 1);
        curG = null;
        document.getElementById('edit-form').style.display = 'none';
        renderPills();
        updateStats();
    }
}

function showTip(e, id) {
  const tip = document.getElementById('tooltip');
  const count = data[id]?.groups?.length || 0;
  tip.innerHTML = `<strong>${id}</strong><br>Kayıtlı Örgüt: ${count}`;
  tip.style.display = 'block';
}
function moveTip(e) {
  const tip = document.getElementById('tooltip');
  tip.style.left = (e.pageX + 15) + 'px'; tip.style.top = (e.pageY + 15) + 'px';
}
function hideTip() { document.getElementById('tooltip').style.display = 'none'; }
window.onkeydown = (e) => { if(e.key === "Escape") closePanel(); };
</script>
</body>
</html>
